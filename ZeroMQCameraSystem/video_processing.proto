syntax = "proto3";

package video_processing;

// ============================================================================
//  Общие перечисления (Enums)
// ============================================================================

/** Тип кадра для маршрутизации между компонентами системы обработки видео. */
enum FrameType {
    /** Исходный, захваченный кадр. Передается от компонента Capturer к Worker. */
    CAPTURED_FRAME = 0;
    
    /** Обработанный кадр. Передается от компонента Worker к Composer. */
    PROCESSED_FRAME = 1;
}

/** Формат хранения цвета для пиксельных данных изображения. */
enum PixelFormat {
    /** Трехканальный формат: Красный, Зеленый, Синий (стандартный порядок). */
    RGB = 0;
    
    /** Трехканальный формат: Синий, Зеленый, Красный (часто используется в OpenCV). */
    BGR = 1;
    
    /** Одноканальное изображение в оттенках серого. */
    GRAY = 2;
}

/** Алгоритм кодирования/сжатия для изображения. */
enum ImageEncoding {
    /** Сжатие с потерями, оптимально для фотографических изображений. */
    JPEG = 0;
    
    /** Сжатие без потерь с поддержкой прозрачности (альфа-канала). */
    PNG = 1;
    
    /** Формат без сжатия в контейнере BMP. */
    BMP = 2;
    
    /** Несжатые "сырые" пиксельные данные в чистом виде. */
    RAW = 3;
}

// ============================================================================
//  Основные структуры данных (Messages)
// ============================================================================

/**
 * Контейнер для пиксельных данных изображения с метаданными.
 * Используется для передачи одного изображения и как часть ImagePair.
 */
message ImageData {
    /** Ширина изображения в пикселях. */
    uint32 width = 1;
    
    /** Высота изображения в пикселях. */
    uint32 height = 2;
    
    /** Цветовой формат пикселей (RGB, BGR, GRAY). */
    PixelFormat pixel_format = 3;
    
    /** Способ кодирования/сжатия данных изображения. */
    ImageEncoding encoding = 4;
    
    /**
     * Бинарный буфер с закодированными пиксельными данными изображения.
     * Интерпретация данных зависит от полей `pixel_format` и `encoding`.
     */
    bytes image_data = 5;
}

/**
 * Пара изображений: исходное и обработанное.
 * Используется для передачи данных от компонента Worker к компоненту Composer.
 */
message ImagePair {
    /** Исходное (захваченное) изображение, полученное от Capturer. */
    ImageData original = 1;
    
    /** Результат обработки, сгенерированный Worker. */
    ImageData processed = 2;
}

/**
 * Универсальный контейнер для передачи видео-кадров между компонентами системы.
 * Содержит общие метаданные кадра и поле `oneof` для гибкого хранения данных
 * в зависимости от этапа конвейера обработки.
 */
message VideoFrame {
    // ----- Общие данные (Common Data) -----
    
    /**
     * Уникальный последовательный идентификатор кадра в рамках потока.
     * Используется для синхронизации, логирования и отслеживания порядка.
     */
    uint64 frame_id = 1;
    
    /**
     * Временная метка захвата кадра в секундах (с дробной частью).
     * Рекомендуется использовать монотонные часы с максимальной точностью.
     */
    double timestamp = 2;
    
    /**
     * Идентификатор компонента-отправителя сообщения.
     * Примеры: "capturer_01", "worker_gpu_02". Используется для отладки и трассировки.
     */
    string sender_id = 3;
    
    /**
     * Тип кадра, определяющий смысл содержимого и маршрут передачи.
     * Должен соответствовать заполненному полю в `content`.
     */
    FrameType frame_type = 4;

    // ----- Данные кадра (Frame Data) -----
    
    /**
     * Поле объединения, содержащее либо одно изображение, либо пару изображений.
     * Выбор поля зависит от типа кадра (`frame_type`):
     * - При `frame_type = CAPTURED_FRAME` должно быть заполнено `single_image`
     * - При `frame_type = PROCESSED_FRAME` должно быть заполнено `image_pair`
     */
    oneof content {
        /**
         * Одно изображение. Используется для передачи захваченного кадра от Capturer к Worker.
         * Должно использоваться только при `frame_type = CAPTURED_FRAME`.
         */
        ImageData single_image = 5;
        
        /**
         * Пара изображений (исходное + обработанное). Используется для передачи результата
         * обработки от Worker к Composer. Должно использоваться только при `frame_type = PROCESSED_FRAME`.
         */
        ImagePair image_pair = 6;
    }
}